#!/usr/bin/env ruby
require 'rubygems'
require 'listen'
require 'readingme'

input  = ARGV[0] || "README.md"
output = ARGV[1] || "README.html"

listener = Listen.to('./', only: %r[#{input}$]) do |modified, _, _|
  table_processor = Readingme::TableProcessor
  encoder         = Readingme::Encoder
  converter       = Readingme::Converter
  github_wrapper  = Readingme::GithubWrapper

  modified.each do |file_name|
    # pandoc_html_cmd = "pandoc -f markdown -t html --ascii"
    # pandoc_textile_cmd = "pandoc -t textile -s #{output} -o #{output}.textile"

    pipeline = table_processor | encoder | converter | github_wrapper
    pipeline << File.open(file_name, "r")
    pipeline.close

    File.open(output,"w") do |file|
      file.write pipeline.read
    end        

  end

  # %x(build_tables.rb #{input} | encode.rb | pandoc -f markdown -t html --ascii | github_wrap.rb > #{output})
  # %x(pandoc -t textile -s #{output} -o #{output}.textile)
end

listener.start

stop = false
trap(:INT){stop = true}
trap(:TERM){stop = true}
begin sleep(1) end while(!stop)
